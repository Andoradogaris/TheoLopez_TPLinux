# TP1 : (re)Familiaration avec un syst√®me GNU/Linux

Dans ce TP, on va passer en revue des √©l√©ments de configurations √©l√©mentaires du syst√®me.

Vous pouvez effectuer ces actions dans la premi√®re VM. On la clonera ensuite avec toutes les configurations pr√©-effectu√©es.

Au menu :

- gestion d'utilisateurs
  - sudo
  - SSH et cl√©s
- configuration r√©seau
- gestion de partitions
- gestion de services

![Heyyyy](./pics/hey.jpeg)

## Sommaire

- [TP1 : (re)Familiaration avec un syst√®me GNU/Linux](#tp1--refamiliaration-avec-un-syst√®me-gnulinux)
  - [Sommaire](#sommaire)
  - [0. Pr√©paration de la machine](#0-pr√©paration-de-la-machine)
  - [I. Utilisateurs](#i-utilisateurs)
    - [1. Cr√©ation et configuration](#1-cr√©ation-et-configuration)
    - [2. SSH](#2-ssh)
  - [II. Partitionnement](#ii-partitionnement)
    - [1. Pr√©paration de la VM](#1-pr√©paration-de-la-vm)
    - [2. Partitionnement](#2-partitionnement)
  - [III. Gestion de services](#iii-gestion-de-services)
  - [1. Interaction avec un service existant](#1-interaction-avec-un-service-existant)
  - [2. Cr√©ation de service](#2-cr√©ation-de-service)
    - [A. Unit√© simpliste](#a-unit√©-simpliste)
    - [B. Modification de l'unit√©](#b-modification-de-lunit√©)

## 0. Pr√©paration de la machine

> **POUR RAPPEL** pour chacune des op√©rations, vous devez fournir dans le compte-rendu : comment r√©aliser l'op√©ration ET la preuve que l'op√©ration a √©t√© bien r√©alis√©e

üåû **Setup de deux machines Rocky Linux configur√©es de fa√ßon basique.**

- **un acc√®s internet (via la carte NAT)**  
 >3: enp0s8: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000  
    link/ether 08:00:27:4b:21:af brd ff:ff:ff:ff:ff:ff  
    inet 10.101.1.11/24 brd 10.101.1.255 scope global noprefixroute   enp0s8  
       valid_lft forever preferred_lft forever  
    inet6 fe80::a00:27ff:fe4b:21af/64 scope link  
       valid_lft forever preferred_lft forever  

- **un acc√®s √† un r√©seau local** (les deux machines peuvent se `ping`) (via la carte Host-Only)
>[theo@localhost ~]$ ping 10.101.1.12  
PING 10.101.1.12 (10.101.1.12) 56(84) bytes of data.  
64 bytes from 10.101.1.12: icmp_seq=1 ttl=64 time=1.45 ms  
64 bytes from 10.101.1.12: icmp_seq=2 ttl=64 time=0.935 ms  
64 bytes from 10.101.1.12: icmp_seq=3 ttl=64 time=0.850 ms  
--- 10.101.1.12 ping statistics ---  
3 packets transmitted, 3 received, 0% packet loss, time 2006ms  
rtt min/avg/max/mdev = 0.850/1.078/1.450/0.265  

- **vous n'utilisez QUE `ssh` pour administrer les machines**
  > ssh theo@10.101.1.11  
  ssh theo@10.101.1.12

- **les machines doivent avoir un nom**
>[theo@localhost ~]$ sudo hostname node2.tp1.b2  
[theo@localhost ~]$ hostname  
node2.tp1.b2  
PS C:\WINDOWS\system32> ssh theo@10.101.1.12  
[theo@node2 ~]$  

- **utiliser `1.1.1.1` comme serveur DNS**
>[theo@node1 ~]$ sudo cat /etc/resolv.conf  
[sudo] password for theo:  
>#Generated by NetworkManager  
search tp1.b2  
nameserver 8.8.8.8  
nameserver 8.8.4.4  
nameserver 1.1.1.1
  
>[theo@node1 ~]$ curl ynov.com
<html>
<head><title>301 Moved Permanently</title></head>
<body>
<center><h1>301 Moved Permanently</h1></center>
<hr><center>nginx/1.18.0</center>
</body>
</html>

> [theo@node1 ~]$ dig ynov.com  
; <<>> DiG 9.16.23-RH <<>> ynov.com  
;; global options: +cmd  
;; Got answer:  
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 58348  
;; flags: qr rd ra; QUERY: 1, ANSWER: 3, AUTHORITY: 0, ADDITIONAL: 1  
;; OPT PSEUDOSECTION:  
; EDNS: version: 0, flags:; udp: 512  
;; QUESTION SECTION:  
;ynov.com.                      IN     A  
;; ANSWER SECTION:  

>>ynov.com.               300     IN     A        104.26.10.233  
ynov.com.               300     IN     A        172.67.74.226  
ynov.com.               300     IN     A        104.26.11.233  

>;; Query time: 39 msec  
>>;; SERVER: 8.8.8.8#53(8.8.8.8)  

>;; WHEN: Thu Nov 17 16:59:25 CET 2022  
;; MSG SIZE  rcvd: 85

- **les machines doivent pouvoir se joindre par leurs noms respectifs**
>[theo@node2 etc]$ ping node1  
PING node1 (10.101.1.11) 56(84) bytes of data.  
64 bytes from node1 (10.101.1.11): icmp_seq=1 ttl=64 time=0.904 ms  
64 bytes from node1 (10.101.1.11): icmp_seq=2 ttl=64 time=0.738 ms  
--- node1 ping statistics ---  
6 packets transmitted, 6 received, 0% packet loss, time 5012ms  
rtt min/avg/max/mdev = 0.738/0.875/0.940/0.066 ms  

- **le pare-feu est configur√© pour bloquer toutes les connexions except√©es celles qui sont n√©cessaires**
  - commande `firewall-cmd`

Pour le r√©seau des diff√©rentes machines (ce sont les IP qui doivent figurer sur les interfaces host-only):

| Name               | IP            |
|--------------------|---------------|
| üñ•Ô∏è `node1.tp1.b2` | `10.101.1.11` |
| üñ•Ô∏è `node2.tp1.b2` | `10.101.1.12` |
| Votre h√¥te         | `10.101.1.1`  |

## I. Utilisateurs

[Une section d√©di√©e aux utilisateurs est dispo dans le m√©mo Linux.](../../cours/memos/commandes.md#gestion-dutilisateurs).

### 1. Cr√©ation et configuration

üåû **Ajouter un utilisateur √† la machine**, qui sera d√©di√© √† son administration

>[theo@node1 etc]$ nano /etc/passwd
>>theo:x:1000:1000:Theo:/home/theo:/bin/bash

üåû **Cr√©er un nouveau groupe `admins`** qui contiendra les utilisateurs de la machine ayant acc√®s aux droits de `root` *via* la commande `sudo`.

>[theo@node1 etc]$ vim group  
usersTP1:x:1001:theo

>[theo@node1 etc]$ sudo vim sudoers  
%usersTP1 ALL=(ALL)     ALL

üåû **Ajouter votre utilisateur √† ce groupe `admins`**

>[theo@node1 etc]$ groups theo  
theo : theo wheel usersTP1

### 2. SSH

[Une section d√©di√©e aux cl√©s SSH existe dans le cours.](../../cours/SSH/README.md)

Afin de se connecter √† la machine de fa√ßon plus s√©curis√©e, on va configurer un √©change de cl√©s SSH lorsque l'on se connecte √† la machine.

üåû **Pour cela...**

>ssh-copy-id theo@10.101.1.12  
/usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: "/c/Users/Th√©o/.ssh/id_rsa.pub"  
/usr/bin/ssh-copy-id: INFO: attempting to log in with the new key(s), to filter out any that are already installed  
/usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- if you are prompted now it is to install the new keys  
theo@10.101.1.12's password:  
  
>Number of key(s) added: 1  
  
>Now try logging into the machine, with:   "ssh 'theo@10.101.1.12'"  
and check to make sure that only the key(s) you wanted were added.


üåû **Assurez vous que la connexion SSH est fonctionnelle**, sans avoir besoin de mot de passe.
  
>$ ssh theo@10.101.1.12  
Last login: Fri Nov 18 14:16:12 2022 from 10.101.1.1  
[theo@node2 ~]$  


## II. Partitionnement

[Il existe une section d√©di√©e au partitionnement dans le cours](../../cours/part/)

### 1. Pr√©paration de la VM

‚ö†Ô∏è **Uniquement sur `node1.tp1.b2`.**

Ajout de deux disques durs √† la machine virtuelle, de 3Go chacun.

### 2. Partitionnement

‚ö†Ô∏è **Uniquement sur `node1.tp1.b2`.**

üåû **Utilisez LVM** pour...

>[theo@node1 mnt]$ df -h  
/dev/mapper/diskGroup-LV1  974M   24K  907M   1% /mnt/part1  
/dev/mapper/diskGroup-LV2  974M   24K  907M   1% /mnt/part2  
/dev/mapper/diskGroup-LV3  974M   24K  907M   1% /mnt/part3  

üåû **Gr√¢ce au fichier `/etc/fstab`**, faites en sorte que cette partition soit mont√©e automatiquement au d√©marrage du syst√®me.

>[theo@node1 mnt]$ sudo mount -av  
/mnt/part1               : successfully mounted  
/mnt/part2               : successfully mounted  
/mnt/part3               : successfully mounted  

‚ú®**Bonus** : amusez vous avez les options de montage. Quelques options int√©ressantes :

- `noexec`
- `ro`
- `user`
- `nosuid`
- `nodev`
- `protect`

## III. Gestion de services

Au sein des syst√®mes GNU/Linux les plus utilis√©s, c'est *systemd* qui est utilis√© comme gestionnaire de services (entre autres).

Pour manipuler les services entretenus par *systemd*, on utilise la commande `systemctl`.

On peut lister les unit√©s `systemd` actives de la machine `systemctl list-units -t service`.

**R√©f√©rez-vous au m√©mo pour voir les autres commandes `systemctl` usuelles.**

## 1. Interaction avec un service existant

‚ö†Ô∏è **Uniquement sur `node1.tp1.b2`.**

Parmi les services syst√®me d√©j√† install√©s sur Rocky, il existe `firewalld`. Cet utilitaire est l'outil de firewalling de Rocky.

üåû **Assurez-vous que...**

>[theo@node1 /]$ systemctl is-active firewalld  
active  
[theo@node1 /]$ systemctl is-enabled firewalld  
enabled  

## 2. Cr√©ation de service

![Cr√©ation de service systemd](./pics/create_service.png)

### A. Unit√© simpliste

‚ö†Ô∏è **Uniquement sur `node1.tp1.b2`.**

üåû **Cr√©er un fichier qui d√©finit une unit√© de service** 

```bash
[theo@node1 system]$ sudo systemctl status web
‚óè web.service - Very simple web service
     Loaded: loaded (/etc/systemd/system/web.service; enabled; vendor preset: disabled)
     Active: active (running) since Fri 2022-11-18 16:54:10 CET; 15s ago
   Main PID: 1320 (python3)
      Tasks: 1 (limit: 5907)
     Memory: 9.2M
        CPU: 253ms
     CGroup: /system.slice/web.service
             ‚îî‚îÄ1320 /usr/bin/python3 -m http.server 8888


Nov 18 16:54:10 node1.tp1.b2 systemd[1]: Started Very simple web service.
```

üåû **Une fois le service d√©marr√©, assurez-vous que pouvez acc√©der au serveur web**

```bash
[theo@node1 ~]$ curl 10.101.1.11:8888
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>Directory listing for /</title>
</head>
<body>
<h1>Directory listing for /</h1>
<hr>
<ul>
<li><a href="afs/">afs/</a></li>
<li><a href="bin/">bin@</a></li>
<li><a href="boot/">boot/</a></li>
<li><a href="dev/">dev/</a></li>
<li><a href="etc/">etc/</a></li>
<li><a href="home/">home/</a></li>
<li><a href="lib/">lib@</a></li>
<li><a href="lib64/">lib64@</a></li>
<li><a href="media/">media/</a></li>
<li><a href="mnt/">mnt/</a></li>
<li><a href="opt/">opt/</a></li>
<li><a href="proc/">proc/</a></li>
<li><a href="root/">root/</a></li>
<li><a href="run/">run/</a></li>
<li><a href="sbin/">sbin@</a></li>
<li><a href="srv/">srv/</a></li>
<li><a href="sys/">sys/</a></li>
<li><a href="tmp/">tmp/</a></li>
<li><a href="usr/">usr/</a></li>
<li><a href="var/">var/</a></li>
</ul>
<hr>
</body>
</html>
```

### B. Modification de l'unit√©

üåû **Pr√©parez l'environnement pour ex√©cuter le mini serveur web Python**

```bash
[theo@node1 meow]$ sudo chown web:web /var/www/meow -R
[theo@node1 meow]$ sudo ls -al /var/www/meow
total 4
drwxr-xr-x. 2 web  web  18 Nov 18 17:30 .
drwxr-xr-x. 3 root root 18 Nov 18 17:30 ..
-rw-r--r--. 1 web  web   5 Nov 18 17:30 toto
```

üåû **Modifiez l'unit√© de service `web.service` cr√©√©e pr√©c√©demment en ajoutant les clauses**

```bash
[theo@node1 meow]$ sudo systemctl cat web

[Unit]
Description=Very simple web service

[Service]
ExecStart=/usr/bin/python3 -m http.server 8888
User=web
WorkingDirectory=/var/www/meow/

[Install]
WantedBy=multi-user.target
```

üåû **V√©rifiez le bon fonctionnement avec une commande `curl`**

```bash
[theo@node1 meow]$ curl 10.101.1.11:8888
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>Directory listing for /</title>
</head>
<body>
<h1>Directory listing for /</h1>
<hr>
<ul>
<li><a href="afs/">afs/</a></li>
<li><a href="bin/">bin@</a></li>
<li><a href="boot/">boot/</a></li>
<li><a href="dev/">dev/</a></li>
<li><a href="etc/">etc/</a></li>
<li><a href="home/">home/</a></li>
<li><a href="lib/">lib@</a></li>
<li><a href="lib64/">lib64@</a></li>
<li><a href="media/">media/</a></li>
<li><a href="mnt/">mnt/</a></li>
<li><a href="opt/">opt/</a></li>
<li><a href="proc/">proc/</a></li>
<li><a href="root/">root/</a></li>
<li><a href="run/">run/</a></li>
<li><a href="sbin/">sbin@</a></li>
<li><a href="srv/">srv/</a></li>
<li><a href="sys/">sys/</a></li>
<li><a href="tmp/">tmp/</a></li>
<li><a href="usr/">usr/</a></li>
<li><a href="var/">var/</a></li>
</ul>
<hr>
</body>
</html>
```